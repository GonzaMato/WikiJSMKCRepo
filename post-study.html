<!--
title: Registrar nuevo estudio de mercado
description: Llene este formulario para registrar un nuevo estudio de mercado a la plataforma. Recuerde que este estudio será revisado por el comité de calidad de Market Knowledge Center
published: true
date: 2024-09-30T18:26:57.786Z
tags: 
editor: code
dateCreated: 2024-09-30T17:09:44.323Z
-->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Estudio de Mercado</title>
    <!-- Enlace al archivo CSS -->
    <link rel="stylesheet" href="styles.css">
    <!-- Enlace al CSS de Choices.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
</head>
<body>
    <h1 class="form-title">Registrar Estudio de Mercado</h1>
			<form id="market-study-form" enctype="multipart/form-data">
        <!-- Campo de Título -->
        <label for="title" class="form-label">Título:</label>
        <input type="text" id="title" name="title" class="form-input" required><br><br>

        <!-- Campo de Sinopsis -->
        <label for="summary" class="form-label">Sinopsis:</label>
        <textarea id="summary" name="summary" rows="5" class="form-textarea" required></textarea><br><br>

        <!-- Campo de Categoría con creación de nuevas etiquetas -->
        <label for="category" class="form-label">Categoría:</label>
        <select id="category" name="category[]" multiple required class="form-select">
            <option value="economy">Economía</option>
            <option value="technology">Tecnología</option>
            <option value="marketing">Marketing</option>
            <option value="sales">Ventas</option>
        </select><br><br>

        <!-- Campo de Autor con creación de nuevas etiquetas -->
        <label for="author" class="form-label">Autor:</label>
        <select id="author" name="author[]" multiple required class="form-select">
            <option value="author1">Autor 1</option>
            <option value="author2">Autor 2</option>
            <option value="author3">Autor 3</option>
        </select><br><br>

        <!-- Campo de Mes y Año de Publicación -->
        <label for="month" class="form-label">Mes y año de Publicación:</label>
        <select id="month" name="month" required class="form-select">
            <option value="jan">Enero - 2021</option>
            <option value="feb">Febrero - 2018</option>
            <option value="mar">Marzo - 2019</option>
        </select><br><br>

        <!-- Campo de País con creación de nuevas etiquetas -->
        <label for="country" class="form-label">País:</label>
        <select id="country" name="country[]" multiple required class="form-select">
            <option value="argentina">Argentina</option>
            <option value="chile">Chile</option>
            <option value="mexico">México</option>
            <option value="spain">España</option>
        </select><br><br>

        <!-- Adjuntar documento -->
        <label for="document" class="form-label">Adjuntar Documento:</label>
        <input type="file" id="document" name="document" class="form-file-input"><br><br>

        <!-- Campo de URL -->
        <label for="url" class="form-label">URL:</label>
        <input type="url" id="url" name="url" class="form-input"><br><br>

        <!-- Botón para registrar -->
        <button type="submit" class="form-submit-btn">Registrar</button>
    </form>

    <!-- Enlace al JavaScript de Choices.js -->
  <script>
    document.getElementById('market-study-form').addEventListener('submit', async function(event) {
        event.preventDefault(); // Evita que el formulario sea enviado de manera tradicional

        // Recoger los datos del formulario
        const title = document.getElementById('title').value;
        const summary = document.getElementById('summary').value;
        const category = Array.from(document.getElementById('category').selectedOptions).map(option => option.value);
        const author = Array.from(document.getElementById('author').selectedOptions).map(option => option.value);
        const month = document.getElementById('month').value;
        const country = Array.from(document.getElementById('country').selectedOptions).map(option => option.value);
        const url = document.getElementById('url').value;

        // Crear una fecha actual para la creación
        const dateCreated = new Date().toISOString();

        // Formatear los datos como un comentario HTML
        const content = `
<!--
title: ${title}
description: ${summary}
published: true
date: ${dateCreated}
tags: ${category.join(', ')}
editor: ckeditor
dateCreated: ${dateCreated}
-->
`;

        const token = process.env.GITHUB_TOKEN; // Inserta tu token de acceso personal aquí
        const owner = process.env.GITHUB_USER // Reemplaza con tu nombre de usuario de GitHub
        const repo = process.env.GITHUB_REPO; // Reemplaza con el nombre del repositorio
        const path = '/pages' // Ruta del archivo en el repositorio (por ejemplo, con el título del estudio)
        const branch = 'main'; // Rama donde se hará el push (ej. 'main')

        // Convertir el contenido a base64 (necesario para la API de GitHub)
        const encodedContent = btoa(content);

        // Verificar si el archivo ya existe en el repositorio
        let sha = null;
        const getFileUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        try {
            const fileResponse = await fetch(getFileUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (fileResponse.ok) {
                const fileData = await fileResponse.json();
                sha = fileData.sha; // Obtener el SHA del archivo si existe para actualizarlo
            }
        } catch (error) {
            console.log('Archivo no encontrado, se creará uno nuevo.');
        }

        // Realizar el push del nuevo archivo o la actualización del existente
        const pushUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        try {
            const response = await fetch(pushUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Añadiendo/actualizando el archivo ${title}`,
                    content: encodedContent,
                    branch: branch,
                    sha: sha // SHA es opcional si el archivo es nuevo
                })
            });

            if (response.ok) {
                const result = await response.json();
                console.log('Archivo subido con éxito:', result);
                alert('Archivo subido con éxito a GitHub');
            } else {
                console.error('Error al subir el archivo a GitHub:', await response.json());
                alert('Error al subir el archivo a GitHub');
            }
        } catch (error) {
            console.error('Error en la solicitud:', error);
            alert('Error en la solicitud');
        }
    });
</script>
</body>
</html>
